# Availability and Scalability - ELB and ASG

* Horizontal scaling - increasing the number of instances (scale in/out)
  
* High availability goes hand in hand with horizontal scaling
  * High availability means running the application in at least 2 data centers/AZs - goal is to sruvive a data center loss

* Vertical scaling - increasing instance size (scale up/down)

* Passive high availability - RDS multi AZ (TODO:????)
* Active high availability - horizontal scaling


# ELB - elastic load balancer

* Load balancers are servers that forward traffic to multiple servers
* ELB is a managed load balancer - AWS handles it and maintains it. Gives you a few controls to configure.

AWS has 4 kinds of load balancer:

* Classic load balancer (v1) (deprecated)
  * HTTP, HTTPS, TLS, SSL
* Application load balancer (v2 - new generation)
  * HTTP, HTTPS, WebSocket
* Network load balancer (v2 - new generation)
  * TCP, TLS, UDP
* Gateway load balancer - 2020
  * OPerates at layer 3 (IP)

Recommended to use newer generation as they provide more features

* Some load balancers can be set up as external, others as internal.

# Application load balancer

* This is layer 7 (HTTP) (TODO:????)
* Load balancing to multiple HTTP applications accross machines

* Routing tables to different target groups
  * path in URL, eg. example.com/123, example.com/abc
  * hostname in url a.example.com, b.example.com
  * query string
  * headers

* A great fit for microservices and container based applications.
* Has port mapping feature to redirect to dynamic port in ECS (Elastic Container Service)

ELB targets:

* EC2 instances - HTTP
* ECS tasks - HTTP
* Lambda functions - HTTP request translated to JSON event
* IP addresses (private)
  

# Steps to set up load balancer

1) Create instances/IPs you want to target, with security groups for inbound traffic
2) Create security group for the load balancer inbound traffic
3) Create target group for load balancer to target instances
4) Create load balancer, with the above security group and target group.

# Network Load Balancer (v2)

* Can handle both TCP and UDP
* Millions of requests per second
* Less latency
* Can periodically health check servers

Target groups - EC2 instances, private IPs

# Gateway Load Balancer (v2)

* Deploy/manage a fleet of network virtual applicances in AWS
* EG. firewalls, traffic inspections. Incoming traffic must be inspected by these services before reaching the destination server, this load balancer balances the traffic sent to each of these inspection type services.
* Operates at layer 3 - IP packets
* **Uses GENEVE protocol on port 6081**

# ELB - Sticky Sessions (session affinity)

* Possible to implement stickiness - same client always redirected to same instance
* This works for classic and application load balancers
* The cookie used for stickiness has an expiration date
* Stickiness can bring imbalance to the load

# ELB -  Sticky Sessions (cookie names)

* Application based cookies
  * Custom cookie
    * Generated by the target application
    * Can include custom attributes
    * Cookie name specified for each target group
    * Some names are reserved by aws, (these start with the string "AWS")
  * Application cookie
    * Generated by load balancer
    * Name is AWSALBAPP
* Duration based cookie
  * Generated by load balancer

# ELB - Cross zone load balancing

* Enabled - each load balancer instance distributes evenly across all registered instances in all AZ.
* Disabled - are distributed evenly across AZs rather than instances - if one AZ has fewer instances, each of those instances will be given more load.

Application Load balancer
  * enabled by default
  * No charges for inter AZ data
Network load balancer + Gateway load balancer
  * Disabled by default
  * Pay charges for inter AZ data if enabled
Classic load balancer
  * Disabled by default
  * No charge if enabled

# SSL/TLS - basics

* Load balancer uses an X.509 certificate
* You can manage certificates use ACM (AWS certificate manager)
* You can also create and upload certificates
* HTTPS listener:
  * Specify default certificate
  * Optional list of certs to support multiple domains.
  * Clients can use SNI (server name indication) to specify the hostname that they reach.

# SSL - server name indication

* SNI solves the problem of loading multiple SSL certificates onto 1 web server to serve multiple websites.
* Newer protocol, requires client to indicate hostname of target server in the SSL handshake.
* The server will find the correct certificate or fall back to the default certificate.
* Only works for new generation load balancers.

# Connection draining

* Feature naming
  * Connection draining - for CLB
  * Deregistration delay - for ALB and NLB

* Time to complete in-flight requests while the instance is de-registering/unhealthy
* Stops sending new requests to the EC2 instance which is de-registering
* Default 300 seconds
* Can be disabled (0)
* Set to low value for short requests, higher value if requests are longer running

# Auto scaling group

* In real life, the load on websites/apps can change
* In the cloud, you can create/destroy servers quickly
* Goal of ASG is:
  * Scale out (add instances) to match increased load
  * Scale in (remove instances) to match decreased load
  * Ensure we have a min and max no instances
  * Register new isntances to load balancer
  * Recreate an EC2 isntance in case a previous one is terminated
  
* ASG are free (you only pay for the instances)

* ELB will health check instances, then ASG will terminate and replace unhealthy instances

ASG atrributes:

* Launch template:
  * Specs for the instance that will be created
* Min/max size, initial capacity
* Scaling policy

# Auto scaling - cloudwatch alarms + scaling

* Scale based on an alarm (eg. trigger based on average CPU usage)
  * Could be scale out or scale in

# Auto scaling groups - dynamic scaling

* Target tracking scaling
  * Simple and easy to set up
  * EG. average instance CPU to be at 40%
* Simple/step scaling
  * Cloudwatch alarm triggered, eg. CPU > 70% then add 2 units
* Scheduled actions based on known usage patterns
* Predictive scaling - continually forecast scaling ahead

# Metrics to scale on

* CPU utilization - averge CPU utilisation across instances
* RequestCountPerTarget - make sure number of requests per EC2 instance is stable
* Average network in/out
* Any custom metric (that you push with cloudwatch)

# ASG - scaling cooldown

* After scaling activity happens you are in cooldown (default 300s)
* During cooldown, ASG will not laucnh or terminate instances
* Ready to use AMI is best so that config time is minimal and scaling can happen faster. Eg. if a new instance takes 2 mins to start then it takes a long time to get feedback.


TODO: load balancer redirect HTTP to HTTPS?
TODO: network layers?
